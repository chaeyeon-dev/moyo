<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>ëª¨ì—¬</title>
<meta name="theme-color" content="#6366f1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ëª¨ì—¬">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --ff:'Plus Jakarta Sans',sans-serif;
  --bg:#f4f3f0;
  --card:#fff;
  --ink:#0c0b0a;
  --ink2:#3d3935;
  --ink3:#857f79;
  --line:#e8e5e1;
  --line2:#f0ede9;
  --acc:#6366f1;
  --acc-l:#eef2ff;
  --acc-b:#c7d2fe;
  --green:#16a34a;
  --green-l:#f0fdf4;
  --green-b:#bbf7d0;
  --red:#dc2626;
  --red-l:#fef2f2;
  --red-b:#fecaca;
  --amber:#d97706;
  --amb-l:#fffbeb;
  --amb-b:#fde68a;
  --gold:#f59e0b;
  --r:16px;
  --r-sm:10px;
  --sh:0 1px 3px rgba(0,0,0,.06),0 0 0 1px rgba(0,0,0,.04);
  --sh-md:0 4px 20px rgba(0,0,0,.09);
  --sh-lg:0 20px 60px rgba(0,0,0,.15);
  --safe-b:env(safe-area-inset-bottom,0px);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{height:100%;overscroll-behavior:none;}
body{font-family:var(--ff);background:var(--bg);color:var(--ink);height:100dvh;overflow:hidden;}
::-webkit-scrollbar{width:0;}

#app{height:100dvh;display:flex;flex-direction:column;position:relative;}
.screens{flex:1;overflow:hidden;position:relative;}
.screen{position:absolute;inset:0;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px 16px calc(72px + var(--safe-b));opacity:0;pointer-events:none;transform:translateY(10px);transition:opacity .2s ease,transform .2s ease;}
.screen.on{opacity:1;pointer-events:auto;transform:none;}

/* ONBOARDING */
#onboarding{position:fixed;inset:0;z-index:500;background:var(--acc);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 28px;transition:opacity .4s ease,transform .4s ease;}
#onboarding.hide{opacity:0;transform:scale(1.04);pointer-events:none;}
.ob-logo{font-size:52px;margin-bottom:16px;}
.ob-title{font-size:32px;font-weight:800;color:#fff;letter-spacing:-.8px;margin-bottom:8px;}
.ob-sub{font-size:15px;color:rgba(255,255,255,.65);margin-bottom:40px;text-align:center;line-height:1.6;}
.ob-card{background:#fff;border-radius:20px;padding:24px;width:100%;max-width:380px;box-shadow:var(--sh-lg);}
.ob-card-title{font-size:17px;font-weight:800;letter-spacing:-.3px;margin-bottom:4px;}
.ob-card-sub{font-size:13px;color:var(--ink3);margin-bottom:20px;}
.avatar-grid{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;}
.av-btn{width:44px;height:44px;border-radius:12px;border:2px solid var(--line);background:var(--line2);font-size:22px;cursor:pointer;transition:all .15s;}
.av-btn.on{border-color:var(--acc);background:var(--acc-l);transform:scale(1.1);}

/* TAB BAR */
.tab-bar{height:calc(58px + var(--safe-b));padding-bottom:var(--safe-b);padding-top:7px;background:rgba(255,255,255,.93);backdrop-filter:blur(24px) saturate(180%);-webkit-backdrop-filter:blur(24px) saturate(180%);border-top:1px solid var(--line);display:flex;flex-shrink:0;}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;cursor:pointer;transition:transform .12s;}
.tab:active{transform:scale(.88);}
.tab-icon{width:42px;height:26px;display:flex;align-items:center;justify-content:center;border-radius:99px;font-size:17px;transition:background .2s;}
.tab.on .tab-icon{background:var(--acc-l);}
.tab-lbl{font-size:10px;font-weight:700;color:var(--ink3);transition:color .2s;letter-spacing:-.1px;}
.tab.on .tab-lbl{color:var(--acc);}

/* OVERLAY / SHEET */
.overlay{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.45);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;padding:0;}
.overlay.on{opacity:1;pointer-events:auto;}
.sheet{background:var(--card);border-radius:22px 22px 0 0;padding:20px 20px calc(20px + var(--safe-b));width:100%;max-width:560px;max-height:88dvh;overflow-y:auto;transform:translateY(24px);transition:transform .28s cubic-bezier(.4,0,.2,1);box-shadow:var(--sh-lg);}
.overlay.on .sheet{transform:none;}
.sheet-handle{width:36px;height:4px;background:var(--line);border-radius:99px;margin:0 auto 18px;}
.sheet-title{font-size:18px;font-weight:800;letter-spacing:-.4px;margin-bottom:4px;}
.sheet-sub{font-size:12px;color:var(--ink3);margin-bottom:18px;}

/* LOADING */
#loading{position:fixed;inset:0;z-index:400;background:var(--acc);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .3s;}
#loading.hide{opacity:0;pointer-events:none;}
.loading-logo{font-size:48px;}
.loading-text{font-size:14px;font-weight:700;color:rgba(255,255,255,.7);}
.loading-spinner{width:32px;height:32px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* TYPOGRAPHY */
.screen-title{font-size:22px;font-weight:800;letter-spacing:-.5px;}
.screen-sub{font-size:13px;color:var(--ink3);margin-top:2px;}
.sec{font-size:11px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--ink3);margin:20px 0 10px 2px;}

/* CARDS */
.card{background:var(--card);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden;margin-bottom:12px;}
.card-p{padding:16px;}
.card-hd{padding:14px 16px;border-bottom:1px solid var(--line2);display:flex;align-items:center;gap:10px;}
.card-hd-ico{width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.card-hd-title{font-size:14px;font-weight:700;letter-spacing:-.2px;}
.card-hd-sub{font-size:11px;color:var(--ink3);margin-top:1px;}

/* HERO */
.hero{border-radius:var(--r);padding:20px;margin-bottom:12px;background:linear-gradient(135deg,#6366f1 0%,#818cf8 100%);position:relative;overflow:hidden;}
.hero::after{content:'';position:absolute;right:-24px;top:-24px;width:120px;height:120px;background:rgba(255,255,255,.08);border-radius:50%;}
.hero::before{content:'';position:absolute;left:-30px;bottom:-30px;width:100px;height:100px;background:rgba(255,255,255,.05);border-radius:50%;}
.hero-greeting{font-size:11px;font-weight:700;letter-spacing:1px;color:rgba(255,255,255,.6);margin-bottom:6px;}
.hero-name-inp{background:transparent;border:none;outline:none;font-family:var(--ff);font-size:24px;font-weight:800;color:#fff;letter-spacing:-.5px;width:100%;caret-color:rgba(255,255,255,.8);}
.hero-name-inp::placeholder{color:rgba(255,255,255,.35);}
.hero-stats{display:flex;gap:0;margin-top:16px;padding-top:14px;border-top:1px solid rgba(255,255,255,.15);}
.hs{flex:1;padding-right:14px;border-right:1px solid rgba(255,255,255,.12);margin-right:14px;}
.hs:last-child{border:none;margin:0;padding:0;}
.hs-n{font-size:18px;font-weight:800;color:#fff;letter-spacing:-.4px;}
.hs-l{font-size:10px;font-weight:600;color:rgba(255,255,255,.5);letter-spacing:.3px;margin-top:1px;}

/* PROFILE BTN */
.profile-btn{position:relative;z-index:10;background:rgba(255,255,255,.15);border:none;border-radius:99px;padding:5px 10px;font-size:11px;font-weight:700;color:#fff;cursor:pointer;display:flex;align-items:center;gap:5px;font-family:var(--ff);}

/* QUICK GRID */
.qg{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.qg-btn{background:var(--card);border-radius:var(--r-sm);box-shadow:var(--sh);padding:14px 6px 12px;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;border:none;transition:all .13s;}
.qg-btn:active{transform:scale(.93);box-shadow:none;}
.qg-icon{font-size:20px;}
.qg-lbl{font-size:11px;font-weight:700;color:var(--ink2);letter-spacing:-.1px;}
.qg-val{font-size:10px;color:var(--ink3);}

/* MEETING CARDS */
.mt-card{background:var(--card);border-radius:var(--r);box-shadow:var(--sh);padding:14px 16px;margin-bottom:10px;cursor:pointer;display:flex;align-items:center;gap:12px;border:1.5px solid transparent;transition:all .17s;}
.mt-card:active{transform:scale(.98);}
.mt-card.cur{border-color:var(--acc);background:var(--acc-l);}
.mt-ico{width:42px;height:42px;border-radius:12px;background:var(--line2);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.mt-card.cur .mt-ico{background:var(--acc-b);}
.mt-info{flex:1;min-width:0;}
.mt-name{font-size:14px;font-weight:700;letter-spacing:-.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mt-meta{font-size:11px;color:var(--ink3);margin-top:2px;}
.mt-badge{font-size:9px;font-weight:700;padding:3px 8px;border-radius:99px;background:var(--acc);color:#fff;flex-shrink:0;}
.mt-host-badge{font-size:9px;font-weight:700;padding:3px 8px;border-radius:99px;background:var(--gold);color:#fff;flex-shrink:0;}
.mt-del{width:28px;height:28px;border-radius:8px;border:none;background:var(--line2);color:var(--ink3);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
.mt-del:active{background:var(--red-l);color:var(--red);}

/* INVITE BANNER */
.invite-banner{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1.5px solid var(--green-b);border-radius:var(--r);padding:14px 16px;margin-bottom:12px;display:flex;align-items:center;gap:12px;cursor:pointer;}
.invite-ico{font-size:24px;flex-shrink:0;}
.invite-info{flex:1;}
.invite-title{font-size:13px;font-weight:700;color:var(--green);}
.invite-sub{font-size:11px;color:#15803d;margin-top:2px;}

/* INPUTS */
.inp{width:100%;padding:12px 14px;background:var(--line2);border:1.5px solid transparent;border-radius:var(--r-sm);font-size:14px;font-weight:500;font-family:var(--ff);color:var(--ink);outline:none;transition:border-color .15s,background .15s;-webkit-appearance:none;}
.inp:focus{background:var(--card);border-color:var(--acc);}
.inp::placeholder{color:var(--ink3);font-weight:400;}
textarea.inp{resize:none;line-height:1.6;}
.inp-row{display:flex;gap:8px;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:12px 18px;border-radius:var(--r-sm);border:none;font-size:14px;font-weight:700;cursor:pointer;font-family:var(--ff);transition:all .15s;white-space:nowrap;letter-spacing:-.2px;}
.btn:active{transform:scale(.96);}
.btn-acc{background:var(--acc);color:#fff;}
.btn-acc:active{background:#5457e0;}
.btn-line{background:var(--card);border:1.5px solid var(--line);color:var(--ink2);}
.btn-green{background:var(--green);color:#fff;}
.btn-sm{padding:9px 14px;font-size:13px;border-radius:9px;}
.btn-xs{padding:6px 11px;font-size:12px;border-radius:8px;}
.btn-full{width:100%;}
.del-btn{width:30px;height:30px;border-radius:8px;border:none;background:var(--line2);color:var(--ink3);cursor:pointer;font-size:12px;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.del-btn:active{background:var(--red-l);color:var(--red);}

/* ROWS */
.row{display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:1px solid var(--line2);}
.row:last-child{border-bottom:none;}

/* DATE */
.d-label{flex:1;min-width:0;}
.d-title{font-size:14px;font-weight:700;letter-spacing:-.2px;margin-bottom:4px;}
.vote-bar{height:3px;border-radius:99px;background:var(--line2);overflow:hidden;margin-bottom:4px;}
.vote-fill{height:100%;background:var(--acc);border-radius:99px;transition:width .4s cubic-bezier(.4,0,.2,1);}
.date-best .vote-fill{background:var(--green);}
.d-meta{font-size:11px;color:var(--ink3);font-weight:500;}
.vote-btn{padding:7px 12px;border-radius:8px;border:1.5px solid var(--line);background:var(--line2);font-size:12px;font-weight:700;cursor:pointer;font-family:var(--ff);transition:all .15s;color:var(--ink2);white-space:nowrap;}
.vote-btn:active{transform:scale(.91);}
.vote-btn.on{background:var(--acc);border-color:var(--acc);color:#fff;}

/* ATTENDANCE */
.att-bar{display:flex;gap:6px;flex-wrap:wrap;padding:12px 16px;border-bottom:1px solid var(--line2);}
.att-chip{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:99px;font-size:11px;font-weight:700;}
.att-chip-go{background:var(--green-l);color:var(--green);}
.att-chip-no{background:var(--red-l);color:var(--red);}
.att-chip-maybe{background:var(--amb-l);color:var(--amber);}
.att-chip-none{background:var(--line2);color:var(--ink3);}
.att-btns{display:flex;gap:4px;}
.att-btn{padding:6px 10px;border-radius:7px;border:1.5px solid var(--line);background:var(--line2);font-size:11px;font-weight:700;cursor:pointer;font-family:var(--ff);transition:all .15s;color:var(--ink3);}
.att-btn:active{transform:scale(.9);}
.att-btn.go{background:var(--green-l);border-color:var(--green-b);color:var(--green);}
.att-btn.no{background:var(--red-l);border-color:var(--red-b);color:var(--red);}
.att-btn.maybe{background:var(--amb-l);border-color:var(--amb-b);color:var(--amber);}

/* MEMBER PILL */
.member-area{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;}
.mpill{display:inline-flex;align-items:center;gap:5px;padding:6px 10px 6px 8px;background:var(--line2);border-radius:99px;font-size:12px;font-weight:600;color:var(--ink2);}
.mpill-host{background:var(--amb-l);color:#92400e;}
.mpill-me{background:var(--acc-l);color:var(--acc);}
.mpill-x{width:16px;height:16px;border-radius:50%;background:var(--ink3);color:#fff;border:none;cursor:pointer;font-size:9px;display:flex;align-items:center;justify-content:center;transition:background .15s;}
.mpill-x:hover{background:var(--red);}
.mpill-edit{background:none;border:none;cursor:pointer;font-size:11px;padding:0;line-height:1;opacity:.7;transition:opacity .15s;}
.mpill-edit:hover{opacity:1;}
.att-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.dot-go{background:var(--green);}
.dot-no{background:var(--red);}
.dot-maybe{background:var(--amber);}
.dot-none{background:var(--line);}

/* PLACE */
.rank{font-size:14px;font-weight:800;color:var(--line);width:20px;text-align:center;flex-shrink:0;}
.rank.top{color:var(--acc);}
.pl-info{flex:1;min-width:0;}
.pl-name{font-size:14px;font-weight:700;letter-spacing:-.2px;}
.pl-meta{font-size:11px;color:var(--ink3);margin-top:2px;}
.like-btn{display:flex;align-items:center;gap:4px;padding:7px 11px;border-radius:8px;border:1.5px solid var(--line);background:var(--line2);font-size:12px;font-weight:700;cursor:pointer;font-family:var(--ff);transition:all .15s;color:var(--ink3);}
.like-btn:active{transform:scale(.9);}
.like-btn.on{background:var(--red-l);border-color:var(--red-b);color:var(--red);}

/* DUTCH */
.dutch-hero{background:var(--ink);border-radius:var(--r);padding:20px;margin-bottom:12px;position:relative;overflow:hidden;}
.dutch-hero::after{content:'';position:absolute;right:-20px;bottom:-20px;width:90px;height:90px;background:rgba(255,255,255,.04);border-radius:50%;}
.dh-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.4);letter-spacing:1px;margin-bottom:4px;}
.dh-amt{font-size:36px;font-weight:800;color:#fff;letter-spacing:-1.5px;line-height:1;}
.dh-row{display:flex;justify-content:space-between;align-items:flex-end;margin-top:14px;padding-top:14px;border-top:1px solid rgba(255,255,255,.1);}
.dh-per{font-size:12px;font-weight:600;color:rgba(255,255,255,.5);}
.dh-per-amt{font-size:18px;font-weight:800;color:rgba(255,255,255,.9);}
.dh-count{font-size:12px;font-weight:600;color:rgba(255,255,255,.4);}
.settle-card{display:flex;align-items:center;gap:8px;padding:12px 14px;border-radius:var(--r-sm);background:var(--line2);margin-bottom:8px;font-size:13px;font-weight:600;}
.sf{color:var(--red);font-weight:700;}
.st{color:var(--green);font-weight:700;flex:1;}
.sa{font-size:14px;font-weight:800;}

/* MEMO */
.type-row{display:flex;gap:6px;margin-bottom:12px;}
.type-btn{padding:7px 14px;border-radius:8px;border:1.5px solid var(--line);background:var(--line2);font-size:12px;font-weight:700;cursor:pointer;font-family:var(--ff);color:var(--ink3);transition:all .15s;}
.type-btn.on{background:var(--acc-l);border-color:var(--acc-b);color:var(--acc);}
.memo-item{padding:14px 16px;border-bottom:1px solid var(--line2);}
.memo-item:last-child{border-bottom:none;}
.memo-top{display:flex;align-items:flex-start;gap:8px;margin-bottom:5px;}
.memo-body{flex:1;font-size:13px;font-weight:500;line-height:1.65;color:var(--ink2);}
.memo-time{font-size:10px;color:var(--ink3);}

/* BADGE */
.badge{font-size:9px;font-weight:700;padding:2px 7px;border-radius:99px;letter-spacing:.2px;flex-shrink:0;}
.badge-green{background:var(--green-l);color:var(--green);}
.badge-acc{background:var(--acc-l);color:var(--acc);}
.badge-red{background:var(--red-l);color:var(--red);}
.badge-amber{background:var(--amb-l);color:var(--amber);}
.badge-gray{background:var(--line2);color:var(--ink3);}
.badge-gold{background:#fef3c7;color:#92400e;}

/* LOCK */
.lock-hint{display:flex;align-items:center;gap:6px;padding:10px 14px;background:var(--amb-l);border-radius:8px;margin-bottom:12px;font-size:12px;font-weight:600;color:var(--amber);}

/* HOST BANNER */
.host-banner{font-size:12px;font-weight:600;padding:10px 14px;border-radius:10px;background:var(--amb-l);color:#92400e;margin-bottom:10px;}
.host-banner-me{background:var(--acc-l);color:var(--acc);}
.btn-text-link{background:none;border:none;font-size:12px;font-weight:700;color:var(--acc);cursor:pointer;text-decoration:underline;padding:0;font-family:var(--ff);}

/* SHARE BOX */
.share-box{background:var(--line2);border-radius:var(--r-sm);padding:14px;font-size:12px;line-height:1.9;color:var(--ink2);font-weight:500;white-space:pre-wrap;max-height:200px;overflow-y:auto;margin-bottom:14px;font-family:monospace;}

/* CODE DISPLAY */
.code-display{background:var(--ink);color:#fff;border-radius:var(--r);padding:20px;text-align:center;margin-bottom:12px;}
.code-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.4);letter-spacing:1.5px;margin-bottom:8px;}
.code-value{font-size:36px;font-weight:800;letter-spacing:8px;color:#fff;}
.code-sub{font-size:11px;color:rgba(255,255,255,.4);margin-top:8px;}

/* SUGGEST */
.sug-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--line2);}
.sug-row:last-child{border-bottom:none;}
.sug-info{flex:1;}
.sug-name{font-size:13px;font-weight:700;}
.sug-meta{font-size:11px;color:var(--ink3);margin-top:1px;}
.sug-cats{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:2px;}

/* EMPTY */
.empty{text-align:center;padding:40px 20px;color:var(--ink3);}
.empty-icon{font-size:34px;opacity:.35;margin-bottom:10px;}
.empty-text{font-size:13px;font-weight:500;}

/* ONLINE DOT */
.online-dot{width:8px;height:8px;border-radius:50%;background:#22c55e;flex-shrink:0;box-shadow:0 0 0 2px rgba(34,197,94,.25);}

/* TOAST */
.toast{position:fixed;bottom:calc(68px + var(--safe-b));left:50%;transform:translateX(-50%) translateY(8px);background:rgba(12,11,10,.9);color:#fff;padding:10px 20px;border-radius:99px;font-size:13px;font-weight:600;opacity:0;pointer-events:none;transition:all .22s;z-index:999;white-space:nowrap;box-shadow:var(--sh-md);}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>
<div id="app">

  <!-- LOADING -->
  <div id="loading">
    <div class="loading-logo">ğŸ‰</div>
    <div class="loading-spinner"></div>
    <div class="loading-text">ëª¨ì—¬ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>

  <!-- ONBOARDING -->
  <div id="onboarding" style="display:none">
    <div class="ob-logo">ğŸ‰</div>
    <div class="ob-title">ëª¨ì—¬</div>
    <div class="ob-sub">ì¹œêµ¬ë“¤ê³¼ ëª¨ì„ì„<br>ë” ì‰½ê²Œ ë§Œë“¤ì–´ìš”</div>
    <div class="ob-card">
      <div class="ob-card-title">ë°˜ê°€ì›Œìš”! ğŸ‘‹</div>
      <div class="ob-card-sub">ì•±ì—ì„œ ì“¸ ì´ë¦„ê³¼ í”„ë¡œí•„ì„ ì„¤ì •í•´ìš”</div>
      <div class="avatar-grid" id="av-grid"></div>
      <input class="inp" id="ob-name" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (ì˜ˆ: ì„ì±„ì—°)" maxlength="10" style="margin-bottom:12px">
      <button class="btn btn-acc btn-full" onclick="completeOnboarding()">ì‹œì‘í•˜ê¸° ğŸš€</button>
    </div>
  </div>

  <!-- SCREENS -->
  <div class="screens">

    <!-- HOME -->
    <div class="screen on" id="s-home">
      <div class="hero">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div class="hero-greeting">ë‚˜ì˜ ëª¨ì„</div>
          <button class="profile-btn" onclick="openProfile()" id="profile-btn">
            <span id="me-avatar">ğŸ‘¤</span><span id="me-name-lbl">í”„ë¡œí•„</span>
          </button>
        </div>
        <input class="hero-name-inp" id="meeting-name" placeholder="ëª¨ì„ ì´ë¦„" maxlength="24" oninput="onNameChange()">
        <div class="hero-stats">
          <div class="hs"><div class="hs-n" id="hs-att">â€”</div><div class="hs-l">ì°¸ì„</div></div>
          <div class="hs"><div class="hs-n" id="hs-date">â€”</div><div class="hs-l">ë‚ ì§œ</div></div>
          <div class="hs"><div class="hs-n" id="hs-cost">â€”</div><div class="hs-l">1ì¸ë‹¹</div></div>
        </div>
      </div>

      <!-- ë©¤ë²„ ì¹´ë“œ -->
      <div class="card">
        <div class="card-hd">
          <div class="card-hd-ico" style="background:#f0fdf4;">ğŸ‘¥</div>
          <div style="flex:1">
            <div class="card-hd-title">ë©¤ë²„</div>
            <div class="card-hd-sub" id="member-count-lbl">ì´ˆëŒ€ ë§í¬ë¡œ ì°¸ì—¬í•´ìš”</div>
          </div>
          <div class="online-dot" id="online-dot" title="ì‹¤ì‹œê°„ ì—°ê²°ë¨"></div>
        </div>
        <div class="card-p" style="padding-bottom:10px">
          <div class="member-area" id="member-area"></div>
          <div id="member-empty-hint"></div>
        </div>
      </div>

      <!-- ì´ë¬´ ë°°ë„ˆ -->
      <div id="host-info-banner"></div>

      <!-- ì´ˆëŒ€ ë°°ë„ˆ -->
      <div class="invite-banner" onclick="openInvite()">
        <div class="invite-ico">ğŸ”—</div>
        <div class="invite-info">
          <div class="invite-title">ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸° ğŸ‘¥</div>
          <div class="invite-sub">ë§í¬ë¡œ ë“¤ì–´ì˜¤ë©´ ìë™ìœ¼ë¡œ ë©¤ë²„ ë“±ë¡ë¼ìš”</div>
        </div>
        <button class="btn btn-green btn-xs">ì´ˆëŒ€</button>
      </div>

      <!-- ë¹ ë¥¸ ì´ë™ -->
      <div class="sec">ë¹ ë¥¸ ì´ë™</div>
      <div class="qg">
        <button class="qg-btn" onclick="goTab('date')"><div class="qg-icon">ğŸ“…</div><div class="qg-lbl">ì¼ì •</div><div class="qg-val" id="qv-date">íˆ¬í‘œ</div></button>
        <button class="qg-btn" onclick="goTab('place')"><div class="qg-icon">ğŸ“</div><div class="qg-lbl">ì¥ì†Œ</div><div class="qg-val" id="qv-place">í›„ë³´</div></button>
        <button class="qg-btn" onclick="goTab('dutch')"><div class="qg-icon">ğŸ’°</div><div class="qg-lbl">ì •ì‚°</div><div class="qg-val" id="qv-dutch">ë”ì¹˜</div></button>
        <button class="qg-btn" onclick="goTab('memo')"><div class="qg-icon">ğŸ“¢</div><div class="qg-lbl">ê³µì§€</div><div class="qg-val" id="qv-memo">ë©”ëª¨</div></button>
      </div>

      <!-- ë‚˜ì˜ ëª¨ì„ ëª©ë¡ -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin:20px 0 10px;">
        <div class="sec" style="margin:0">ë‚˜ì˜ ëª¨ì„</div>
        <button class="btn btn-acc btn-xs" onclick="openCreateMeeting()">+ ìƒˆ ëª¨ì„</button>
      </div>
      <div id="meetings-list"></div>
    </div>

    <!-- DATE -->
    <div class="screen" id="s-date">
      <div style="margin-bottom:20px">
        <div class="screen-title">ì¼ì • íˆ¬í‘œ</div>
        <div class="screen-sub">ì—¬ëŸ¬ ë‚ ì§œì— íˆ¬í‘œ ê°€ëŠ¥í•´ìš”</div>
      </div>
      <div class="card card-p" style="margin-bottom:12px">
        <div class="inp-row" style="margin-bottom:8px">
          <input class="inp" type="date" id="date-inp">
          <input class="inp" placeholder="ì‹œê°„ (ì˜ˆ: ì˜¤í›„ 6ì‹œ)" id="time-inp" style="max-width:130px">
        </div>
        <button class="btn btn-acc btn-full btn-sm" onclick="addDate()">ë‚ ì§œ ì¶”ê°€</button>
      </div>
      <div class="card"><div id="date-list"></div></div>
      <div id="att-section"></div>
    </div>

    <!-- PLACE -->
    <div class="screen" id="s-place">
      <div style="margin-bottom:20px">
        <div class="screen-title">ì¥ì†Œ í›„ë³´</div>
        <div class="screen-sub">â¤ï¸ ëˆŒëŸ¬ì„œ íˆ¬í‘œ Â· ëª¨ë‘ê°€ ì¶”ê°€ ê°€ëŠ¥</div>
      </div>
      <div class="card card-p">
        <div style="display:flex;flex-direction:column;gap:8px">
          <input class="inp" id="place-name" placeholder="ì¥ì†Œ ì´ë¦„ (ì˜ˆ: í™ëŒ€ ì´ìì¹´ì•¼)">
          <div class="inp-row">
            <input class="inp" id="place-cat" placeholder="ì¢…ë¥˜ (ì˜ˆ: ì¼ì‹, ì¹´í˜)">
            <input class="inp" id="place-price" placeholder="ê°€ê²©ëŒ€" style="max-width:120px">
          </div>
          <button class="btn btn-acc btn-sm" style="align-self:flex-start" onclick="addPlace()">+ ì¶”ê°€</button>
        </div>
      </div>
      <div class="card card-p" style="padding-bottom:12px">
        <div class="sug-cats">
          <button class="btn btn-line btn-xs" onclick="suggestPlaces('ğŸ– ê³ ê¸°')">ğŸ– ê³ ê¸°</button>
          <button class="btn btn-line btn-xs" onclick="suggestPlaces('ğŸ£ ì¼ì‹')">ğŸ£ ì¼ì‹</button>
          <button class="btn btn-line btn-xs" onclick="suggestPlaces('ğŸº ìˆ ì§‘')">ğŸº ìˆ ì§‘</button>
          <button class="btn btn-line btn-xs" onclick="suggestPlaces('â˜• ì¹´í˜')">â˜• ì¹´í˜</button>
          <button class="btn btn-line btn-xs" onclick="suggestPlaces('ğŸ¤ ë…¸ë˜ë°©')">ğŸ¤ ë…¸ë˜ë°©</button>
          <button class="btn btn-line btn-xs" onclick="suggestPlaces('ğŸ” ë°©íƒˆì¶œ')">ğŸ” ë°©íƒˆì¶œ</button>
        </div>
        <div id="sug-wrap"></div>
      </div>
      <div class="card"><div id="place-list"></div></div>
    </div>

    <!-- DUTCH -->
    <div class="screen" id="s-dutch">
      <div style="margin-bottom:20px">
        <div class="screen-title">ì •ì‚°</div>
        <div class="screen-sub">ì´ë¬´ë§Œ ì§€ì¶œì„ ì¶”ê°€Â·ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”</div>
      </div>
      <div class="dutch-hero">
        <div class="dh-label">ì´ ì§€ì¶œ</div>
        <div class="dh-amt" id="d-total">â‚©0</div>
        <div class="dh-row">
          <div><div class="dh-per">1ì¸ë‹¹</div><div class="dh-per-amt" id="d-per">â‚©0</div></div>
          <div class="dh-count" id="d-count">0ëª… ê¸°ì¤€</div>
        </div>
      </div>
      <div id="dutch-add-area"></div>
      <div class="card"><div id="exp-list"></div></div>
      <div class="sec">ì •ì‚° ê²°ê³¼</div>
      <div id="settle-result"></div>
      <button class="btn btn-acc btn-full" onclick="openShare()" style="margin-top:4px">ğŸŸ¡ ì¹´ì¹´ì˜¤ ê³µìœ ìš© ìš”ì•½</button>
    </div>

    <!-- MEMO -->
    <div class="screen" id="s-memo">
      <div style="margin-bottom:20px">
        <div class="screen-title">ë©”ëª¨ Â· ê³µì§€</div>
        <div class="screen-sub">ëª¨ì„ ê´€ë ¨ ë‚´ìš©ì„ ë‚¨ê²¨ìš”</div>
      </div>
      <div class="card card-p">
        <div class="type-row">
          <button class="type-btn on" id="tb-notice" onclick="setMemoType('notice')">ğŸ“¢ ê³µì§€</button>
          <button class="type-btn" id="tb-memo" onclick="setMemoType('memo')">ğŸ“ ë©”ëª¨</button>
        </div>
        <textarea class="inp" id="memo-inp" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3" style="margin-bottom:8px"></textarea>
        <button class="btn btn-acc btn-full btn-sm" onclick="addMemo()">ë“±ë¡</button>
      </div>
      <div class="card" style="margin-top:12px"><div id="memo-list"></div></div>
    </div>

  </div>

  <!-- TAB BAR -->
  <nav class="tab-bar">
    <button class="tab on" id="tab-home"  onclick="goTab('home')"><div class="tab-icon">ğŸ </div><div class="tab-lbl">í™ˆ</div></button>
    <button class="tab"    id="tab-date"  onclick="goTab('date')"><div class="tab-icon">ğŸ“…</div><div class="tab-lbl">ì¼ì •</div></button>
    <button class="tab"    id="tab-place" onclick="goTab('place')"><div class="tab-icon">ğŸ“</div><div class="tab-lbl">ì¥ì†Œ</div></button>
    <button class="tab"    id="tab-dutch" onclick="goTab('dutch')"><div class="tab-icon">ğŸ’°</div><div class="tab-lbl">ì •ì‚°</div></button>
    <button class="tab"    id="tab-memo"  onclick="goTab('memo')"><div class="tab-icon">ğŸ“¢</div><div class="tab-lbl">ê³µì§€</div></button>
  </nav>
</div>

<!-- MODALS -->

<!-- ì´ˆëŒ€ -->
<div class="overlay" id="ov-invite" onclick="closeOv('invite',event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°</div>
    <div class="sheet-sub">ì½”ë“œë‚˜ ë§í¬ë¥¼ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”</div>
    <div class="code-display">
      <div class="code-label">ì´ˆëŒ€ ì½”ë“œ</div>
      <div class="code-value" id="invite-code">â€”</div>
      <div class="code-sub">ì¹œêµ¬ê°€ ì•±ì—ì„œ ì´ ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ë°”ë¡œ ì°¸ì—¬í•´ìš”</div>
    </div>
    <div class="inp-row" style="gap:8px;margin-bottom:10px">
      <button class="btn btn-line btn-sm" onclick="closeSheet('invite')" style="flex:1">ë‹«ê¸°</button>
      <button class="btn btn-acc btn-sm" onclick="copyInviteLink()" style="flex:2">ğŸ”— ë§í¬ ë³µì‚¬</button>
    </div>
    <button class="btn btn-full btn-line btn-sm" onclick="copyCode()">ğŸ“‹ ì½”ë“œë§Œ ë³µì‚¬</button>
  </div>
</div>

<!-- ì°¸ì—¬ -->
<div class="overlay" id="ov-join" onclick="closeOv('join',event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">ëª¨ì„ ì°¸ì—¬í•˜ê¸°</div>
    <div class="sheet-sub">ì¹œêµ¬ì—ê²Œ ë°›ì€ ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
    <input class="inp" id="join-code-inp" placeholder="ì´ˆëŒ€ ì½”ë“œ 6ìë¦¬" maxlength="6"
      style="text-align:center;font-size:24px;font-weight:800;letter-spacing:6px;margin-bottom:12px"
      oninput="this.value=this.value.toUpperCase()">
    <div class="inp-row">
      <button class="btn btn-line btn-sm" onclick="closeSheet('join')" style="flex:1">ì·¨ì†Œ</button>
      <button class="btn btn-acc btn-sm" onclick="joinMeeting()" style="flex:2">ì°¸ì—¬í•˜ê¸°</button>
    </div>
  </div>
</div>

<!-- ìƒˆ ëª¨ì„ -->
<div class="overlay" id="ov-create" onclick="closeOv('create',event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">ìƒˆ ëª¨ì„ ë§Œë“¤ê¸°</div>
    <div class="sheet-sub">ë‚´ê°€ ì´ë¬´(ë°©ì¥)ê°€ ë¼ìš”</div>
    <input class="inp" id="new-meeting-name" placeholder="ëª¨ì„ ì´ë¦„ (ì˜ˆ: ëŒ€í•™ ë™ê¸° ëª¨ì„)" maxlength="24" style="margin-bottom:8px">
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px" id="emoji-picker"></div>
    <div class="inp-row">
      <button class="btn btn-line btn-sm" onclick="closeSheet('create')" style="flex:1">ì·¨ì†Œ</button>
      <button class="btn btn-acc btn-sm" onclick="createMeeting()" style="flex:2">ë§Œë“¤ê¸° ğŸ‰</button>
    </div>
    <div style="height:12px"></div>
    <div style="text-align:center;font-size:12px;color:var(--ink3);margin-bottom:8px">â€” ë˜ëŠ” â€”</div>
    <button class="btn btn-line btn-full btn-sm" onclick="closeSheet('create');openSheet('join')">ğŸ”— ì´ˆëŒ€ ì½”ë“œë¡œ ì°¸ì—¬í•˜ê¸°</button>
  </div>
</div>

<!-- í”„ë¡œí•„ ìˆ˜ì • -->
<div class="overlay" id="ov-profile" onclick="closeOv('profile',event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">í”„ë¡œí•„ ìˆ˜ì •</div>
    <div class="sheet-sub">ë‹‰ë„¤ì„ê³¼ ì•„ë°”íƒ€ë¥¼ ë³€ê²½í•´ìš”</div>
    <div class="avatar-grid" id="profile-av-grid" style="margin-bottom:16px"></div>
    <input class="inp" id="profile-name-inp" placeholder="ìƒˆ ë‹‰ë„¤ì„" maxlength="10" style="margin-bottom:12px">
    <div class="inp-row">
      <button class="btn btn-line btn-sm" onclick="closeSheet('profile')" style="flex:1">ì·¨ì†Œ</button>
      <button class="btn btn-acc btn-sm" onclick="saveProfile()" style="flex:2">ì €ì¥í•˜ê¸°</button>
    </div>
  </div>
</div>

<!-- ì´ë¬´ ë„˜ê¸°ê¸° -->
<div class="overlay" id="ov-hostpass" onclick="closeOv('hostpass',event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">ğŸ‘‘ ì´ë¬´ ë„˜ê¸°ê¸°</div>
    <div class="sheet-sub">ìƒˆ ì´ë¬´ë¥¼ ì„ íƒí•˜ë©´ ê¶Œí•œì´ ì¦‰ì‹œ ë„˜ì–´ê°€ìš”</div>
    <div id="hostpass-list"></div>
    <div style="height:8px"></div>
    <button class="btn btn-line btn-full btn-sm" onclick="closeSheet('hostpass')">ì·¨ì†Œ</button>
  </div>
</div>

<!-- ì¹´ì¹´ì˜¤ ê³µìœ  -->
<div class="overlay" id="ov-share" onclick="closeOv('share',event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">ì¹´ì¹´ì˜¤ ê³µìœ ìš© ìš”ì•½</div>
    <div class="sheet-sub">ë³µì‚¬í•´ì„œ ì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</div>
    <div class="share-box" id="share-text"></div>
    <div class="inp-row">
      <button class="btn btn-line btn-sm" onclick="closeSheet('share')" style="flex:1">ë‹«ê¸°</button>
      <button class="btn btn-acc btn-sm" onclick="copyShare()" style="flex:2">ğŸ“‹ ë³µì‚¬í•˜ê¸°</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://bfiawotoncpdqelbugjf.supabase.co';
const SUPABASE_KEY = 'sb_publishable_5ZSJ9QDx2xDNCe2FLj-WXA_jutb24yK';
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

// â”€â”€ CONSTANTS â”€â”€
const AVATARS = ['ğŸ˜€','ğŸ˜','ğŸ¥³','ğŸ¤©','ğŸ˜„','ğŸ™‚','ğŸ¥°','ğŸ˜œ','ğŸ¤“','ğŸ«¡','ğŸ‘»','ğŸ¯','ğŸ¦Š','ğŸ»','ğŸ¼'];
const MT_EMOJIS = ['ğŸ‰','ğŸ»','ğŸ•','ğŸ‚','ğŸ®','ğŸ¤','âš½','ğŸœ','ğŸ²','ğŸ¸','ğŸ–','âœˆ','ğŸ¯','ğŸ¥‚'];
const SUGGEST_DATA = {
  'ğŸ– ê³ ê¸°':[{name:'ì—°íƒ„êµ¬ì´ ê³ ê¸°ì§‘',cat:'í•œì‹',price:'ì¸ë‹¹ 2~3ë§Œì›'},{name:'í‘ë¼ì§€ ì „ë¬¸ì ',cat:'í•œì‹',price:'ì¸ë‹¹ 3ë§Œì›'},{name:'ì†Œê³ ê¸° êµ¬ì´',cat:'í•œì‹',price:'ì¸ë‹¹ 4~5ë§Œì›'}],
  'ğŸ£ ì¼ì‹':[{name:'ì´ìì¹´ì•¼',cat:'ì¼ì‹',price:'ì¸ë‹¹ 3~4ë§Œì›'},{name:'ìŠ¤ì‹œ ì˜¤ë§ˆì¹´ì„¸',cat:'ì¼ì‹',price:'ì¸ë‹¹ 5ë§Œì›+'},{name:'ë¼ë©˜ ì „ë¬¸ì ',cat:'ì¼ì‹',price:'ì¸ë‹¹ 1.5ë§Œì›'}],
  'ğŸº ìˆ ì§‘':[{name:'ìˆ˜ì œë§¥ì£¼ ë°”',cat:'ìˆ ì§‘',price:'ì¸ë‹¹ 2~3ë§Œì›'},{name:'ì™€ì¸ë°”',cat:'ìˆ ì§‘',price:'ì¸ë‹¹ 4~5ë§Œì›'},{name:'í¬ì°¨',cat:'ìˆ ì§‘',price:'ì¸ë‹¹ 2ë§Œì›'}],
  'â˜• ì¹´í˜':[{name:'ë£¨í”„íƒ‘ ì¹´í˜',cat:'ì¹´í˜',price:'ì¸ë‹¹ 1~1.5ë§Œì›'},{name:'ë³´ë“œê²Œì„ ì¹´í˜',cat:'ì¹´í˜',price:'ì¸ë‹¹ 8ì²œì›'},{name:'ê°ì„± ì¹´í˜',cat:'ì¹´í˜',price:'ì¸ë‹¹ 8ì²œì›'}],
  'ğŸ¤ ë…¸ë˜ë°©':[{name:'ì¼ë°˜ ë…¸ë˜ë°©',cat:'ë…¸ë˜ë°©',price:'ì¸ë‹¹ 1~2ë§Œì›'},{name:'ì£¼ë¥˜ ë…¸ë˜ë°©',cat:'ë…¸ë˜ë°©',price:'ì¸ë‹¹ 3ë§Œì›'},{name:'ì½”ì¸ë…¸ë˜ë°©',cat:'ë…¸ë˜ë°©',price:'500ì›/ê³¡'}],
  'ğŸ” ë°©íƒˆì¶œ':[{name:'ê³µí¬ í…Œë§ˆ',cat:'ë°©íƒˆì¶œ',price:'ì¸ë‹¹ 2ë§Œì›'},{name:'ì¶”ë¦¬ í…Œë§ˆ',cat:'ë°©íƒˆì¶œ',price:'ì¸ë‹¹ 2ë§Œì›'},{name:'ì–´ë“œë²¤ì²˜',cat:'ë°©íƒˆì¶œ',price:'ì¸ë‹¹ 2ë§Œì›'}],
};

// â”€â”€ STATE â”€â”€
let ME = JSON.parse(localStorage.getItem('moyo-me') || 'null');
let activeRoomId = localStorage.getItem('moyo-active-room') || null;
let myRoomIds = JSON.parse(localStorage.getItem('moyo-my-rooms') || '[]');
let rooms = {}; // roomId -> room data
let members = {}; // roomId -> members[]
let dates = {}; // roomId -> dates[]
let places = {}; // roomId -> places[]
let expenses = {}; // roomId -> expenses[]
let memos = {}; // roomId -> memos[]
let memoType = 'notice';
let selectedEmoji = MT_EMOJIS[0];
let selectedAvatar = AVATARS[0];
let profileAvatar = null;
let realtimeChannels = {};

// â”€â”€ HELPERS â”€â”€
function R() { return rooms[activeRoomId] || {}; }
function isHost() { return ME && R().host_id === ME.id; }
function getMembers() { return members[activeRoomId] || []; }
function getDates() { return dates[activeRoomId] || []; }
function getPlaces() { return places[activeRoomId] || []; }
function getExpenses() { return expenses[activeRoomId] || []; }
function getMemos() { return memos[activeRoomId] || []; }
function amIMember() { return getMembers().find(m => m.user_id === ME?.id); }
function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:6}, () => chars[Math.floor(Math.random()*chars.length)]).join('');
}
function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

// â”€â”€ INIT â”€â”€
async function init() {
  initOnboarding();

  // URLì—ì„œ ì´ˆëŒ€ ì½”ë“œ í™•ì¸
  const urlCode = new URLSearchParams(location.search).get('join');

  if (!ME) {
    // ì‹ ê·œ ì‚¬ìš©ì
    hideLoading();
    showOnboarding();
    if (urlCode) {
      localStorage.setItem('moyo-pending-join', urlCode.toUpperCase());
    }
    return;
  }

  // ê¸°ì¡´ ì‚¬ìš©ì - ë°© ë°ì´í„° ë¡œë“œ
  await loadAllRooms();
  hideLoading();

  if (urlCode) {
    // ì´ˆëŒ€ ë§í¬ë¡œ ì ‘ì†
    await handleInviteUrl(urlCode.toUpperCase());
  } else if (!activeRoomId || !rooms[activeRoomId]) {
    // í™œì„± ë°©ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë°©ìœ¼ë¡œ
    if (myRoomIds.length > 0) {
      activeRoomId = myRoomIds[0];
    } else {
      // ë°©ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ë§Œë“¤ê¸°
      await createFirstRoom();
    }
  }

  await loadRoomData(activeRoomId);
  subscribeToRoom(activeRoomId);
  renderAll();
}

function hideLoading() {
  document.getElementById('loading').classList.add('hide');
  setTimeout(() => { document.getElementById('loading').style.display='none'; }, 400);
}

function showOnboarding() {
  const ob = document.getElementById('onboarding');
  ob.style.display = 'flex';
}

// â”€â”€ ONBOARDING â”€â”€
function initOnboarding() {
  const grid = document.getElementById('av-grid');
  grid.innerHTML = AVATARS.slice(0,8).map((a,i) =>
    `<button class="av-btn${i===0?' on':''}" onclick="selectAvatar(this,'${a}')">${a}</button>`
  ).join('');
  selectedAvatar = AVATARS[0];
}

function selectAvatar(el, av) {
  document.querySelectorAll('.av-btn').forEach(b => b.classList.remove('on'));
  el.classList.add('on');
  selectedAvatar = av;
}

async function completeOnboarding() {
  const name = document.getElementById('ob-name').value.trim();
  if (!name) { toast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!'); return; }

  ME = { id: genId(), name, avatar: selectedAvatar };
  localStorage.setItem('moyo-me', JSON.stringify(ME));

  // Supabaseì— ì‚¬ìš©ì ì €ì¥
  await db.from('users').upsert({ id: ME.id, name: ME.name, avatar: ME.avatar });

  document.getElementById('onboarding').classList.add('hide');
  setTimeout(() => { document.getElementById('onboarding').style.display='none'; }, 400);

  // ëŒ€ê¸° ì¤‘ì¸ ì´ˆëŒ€ ì½”ë“œ í™•ì¸
  const pendingCode = localStorage.getItem('moyo-pending-join');
  if (pendingCode) {
    localStorage.removeItem('moyo-pending-join');
    await handleInviteUrl(pendingCode);
    renderAll();
    return;
  }

  // ì²« ë°© ë§Œë“¤ê¸°
  await createFirstRoom();
  renderAll();
  toast('í™˜ì˜í•´ìš”, ' + name + '! ğŸ‰');
}

// â”€â”€ ROOM LOADING â”€â”€
async function loadAllRooms() {
  if (!myRoomIds.length) return;
  const { data } = await db.from('rooms').select('*').in('id', myRoomIds);
  if (data) data.forEach(r => { rooms[r.id] = r; });
}

async function loadRoomData(roomId) {
  if (!roomId) return;
  const [r, m, d, p, e, mo] = await Promise.all([
    db.from('rooms').select('*').eq('id', roomId).single(),
    db.from('members').select('*, users(*)').eq('room_id', roomId),
    db.from('dates').select('*').eq('room_id', roomId).order('created_at'),
    db.from('places').select('*').eq('room_id', roomId).order('created_at'),
    db.from('expenses').select('*').eq('room_id', roomId).order('created_at'),
    db.from('memos').select('*').eq('room_id', roomId).order('created_at', {ascending:false}),
  ]);
  if (r.data) rooms[roomId] = r.data;
  if (m.data) members[roomId] = m.data;
  if (d.data) dates[roomId] = d.data;
  if (p.data) places[roomId] = p.data;
  if (e.data) expenses[roomId] = e.data;
  if (mo.data) memos[roomId] = mo.data;
}

// â”€â”€ CREATE FIRST ROOM â”€â”€
async function createFirstRoom() {
  const roomId = genId();
  const room = {
    id: roomId,
    name: '',
    emoji: 'ğŸ‰',
    host_id: ME.id,
    invite_code: genCode(),
  };
  await db.from('rooms').insert(room);
  await db.from('members').insert({ id: genId(), room_id: roomId, user_id: ME.id, att: 'none' });

  rooms[roomId] = room;
  members[roomId] = [{ id: genId(), room_id: roomId, user_id: ME.id, att: 'none', users: ME }];
  dates[roomId] = []; places[roomId] = []; expenses[roomId] = []; memos[roomId] = [];

  myRoomIds.push(roomId);
  activeRoomId = roomId;
  localStorage.setItem('moyo-my-rooms', JSON.stringify(myRoomIds));
  localStorage.setItem('moyo-active-room', activeRoomId);
  subscribeToRoom(roomId);
}

// â”€â”€ REALTIME â”€â”€
function subscribeToRoom(roomId) {
  if (realtimeChannels[roomId]) return;
  const ch = db.channel('room-' + roomId);

  // members ë³€ê²½
  ch.on('postgres_changes', { event: '*', schema: 'public', table: 'members', filter: `room_id=eq.${roomId}` },
    async () => {
      const { data } = await db.from('members').select('*, users(*)').eq('room_id', roomId);
      if (data) members[roomId] = data;
      if (activeRoomId === roomId) { renderHome(); showSync(); }
    });

  // dates ë³€ê²½
  ch.on('postgres_changes', { event: '*', schema: 'public', table: 'dates', filter: `room_id=eq.${roomId}` },
    async () => {
      const { data } = await db.from('dates').select('*').eq('room_id', roomId).order('created_at');
      if (data) dates[roomId] = data;
      if (activeRoomId === roomId) { renderDates(); showSync(); }
    });

  // places ë³€ê²½
  ch.on('postgres_changes', { event: '*', schema: 'public', table: 'places', filter: `room_id=eq.${roomId}` },
    async () => {
      const { data } = await db.from('places').select('*').eq('room_id', roomId).order('created_at');
      if (data) places[roomId] = data;
      if (activeRoomId === roomId) { renderPlaces(); showSync(); }
    });

  // expenses ë³€ê²½
  ch.on('postgres_changes', { event: '*', schema: 'public', table: 'expenses', filter: `room_id=eq.${roomId}` },
    async () => {
      const { data } = await db.from('expenses').select('*').eq('room_id', roomId).order('created_at');
      if (data) expenses[roomId] = data;
      if (activeRoomId === roomId) { renderDutch(); showSync(); }
    });

  // memos ë³€ê²½
  ch.on('postgres_changes', { event: '*', schema: 'public', table: 'memos', filter: `room_id=eq.${roomId}` },
    async () => {
      const { data } = await db.from('memos').select('*').eq('room_id', roomId).order('created_at', {ascending:false});
      if (data) memos[roomId] = data;
      if (activeRoomId === roomId) { renderMemos(); showSync(); }
    });

  // rooms ë³€ê²½ (ì´ë¦„, ì´ë¬´ ë“±)
  ch.on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${roomId}` },
    async () => {
      const { data } = await db.from('rooms').select('*').eq('id', roomId).single();
      if (data) rooms[roomId] = data;
      if (activeRoomId === roomId) { renderHome(); showSync(); }
    });

  ch.subscribe();
  realtimeChannels[roomId] = ch;
}

function showSync() {
  const dot = document.getElementById('online-dot');
  if (!dot) return;
  dot.style.background = '#6366f1';
  setTimeout(() => { dot.style.background = '#22c55e'; }, 600);
}

// â”€â”€ INVITE URL â”€â”€
async function handleInviteUrl(code) {
  // ì´ë¯¸ ë‚´ ë°©ì¸ì§€ í™•ì¸
  const existingRoom = Object.values(rooms).find(r => r.invite_code === code);
  if (existingRoom) {
    activeRoomId = existingRoom.id;
    localStorage.setItem('moyo-active-room', activeRoomId);
    return;
  }

  // Supabaseì—ì„œ ì½”ë“œë¡œ ë°© ì°¾ê¸°
  toast('ëª¨ì„ ì°¾ëŠ” ì¤‘...');
  const { data } = await db.from('rooms').select('*').eq('invite_code', code).single();
  if (!data) { toast('ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”'); return; }

  // ë©¤ë²„ ì¶”ê°€
  const alreadyMember = await db.from('members').select('id').eq('room_id', data.id).eq('user_id', ME.id).single();
  if (!alreadyMember.data) {
    await db.from('members').insert({ id: genId(), room_id: data.id, user_id: ME.id, att: 'none' });
  }

  rooms[data.id] = data;
  if (!myRoomIds.includes(data.id)) myRoomIds.push(data.id);
  activeRoomId = data.id;
  localStorage.setItem('moyo-my-rooms', JSON.stringify(myRoomIds));
  localStorage.setItem('moyo-active-room', activeRoomId);

  await loadRoomData(data.id);
  subscribeToRoom(data.id);
  toast('ğŸ‰ ' + (data.name||'ëª¨ì„') + 'ì— ì°¸ì—¬í–ˆì–´ìš”!');
}

// â”€â”€ NAVIGATION â”€â”€
function goTab(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  document.getElementById('s-'+id).classList.add('on');
  document.getElementById('tab-'+id).classList.add('on');
  if(id==='home')  renderHome();
  if(id==='date')  renderDates();
  if(id==='place') renderPlaces();
  if(id==='dutch') renderDutch();
  if(id==='memo')  renderMemos();
}

function renderAll() {
  const activeTab = document.querySelector('.tab.on')?.id?.replace('tab-','') || 'home';
  goTab(activeTab);
}

// â”€â”€ HOME â”€â”€
function renderHome() {
  const room = R();
  const inp = document.getElementById('meeting-name');
  if (inp && inp !== document.activeElement) inp.value = room.name || '';

  const mbs = getMembers();
  const exps = getExpenses();
  const dts = getDates();
  const goCount = mbs.filter(m => m.att==='go').length;
  const total = exps.reduce((s,e) => s+e.amt, 0);
  const count = mbs.length || 1;
  const per = total ? Math.ceil(total/count) : 0;
  const best = [...dts].sort((a,b) => (b.voters?.length||0)-(a.voters?.length||0))[0];

  document.getElementById('hs-att').textContent = goCount || 'â€”';
  document.getElementById('hs-date').textContent = best?.voters?.length > 0 ? best.label.split(' ')[0] : (dts.length ? dts.length+'ê°œ' : 'â€”');
  document.getElementById('hs-cost').textContent = per ? 'â‚©'+per.toLocaleString() : 'â€”';
  document.getElementById('qv-date').textContent  = dts.length  ? dts.length+'ê°œ'  : 'íˆ¬í‘œ';
  document.getElementById('qv-place').textContent = getPlaces().length ? getPlaces().length+'ê°œ' : 'í›„ë³´';
  document.getElementById('qv-dutch').textContent = per ? 'â‚©'+per.toLocaleString() : 'ë”ì¹˜';
  document.getElementById('qv-memo').textContent  = getMemos().length ? getMemos().length+'ê°œ' : 'ë©”ëª¨';

  // í”„ë¡œí•„ ë²„íŠ¼
  if (ME) {
    const av = document.getElementById('me-avatar');
    const nl = document.getElementById('me-name-lbl');
    if (av) av.textContent = ME.avatar;
    if (nl) nl.textContent = ME.name;
  }

  // ë©¤ë²„
  const cnt = mbs.length;
  document.getElementById('member-count-lbl').textContent = cnt ? cnt+'ëª… ì°¸ì—¬ ì¤‘' : 'ì•„ì§ ì•„ë¬´ë„ ì—†ì–´ìš”';

  document.getElementById('member-area').innerHTML = mbs.map(m => {
    const u = m.users || {};
    const isMe = ME && m.user_id === ME.id;
    const isH = m.user_id === room.host_id;
    const dot = m.att==='go'?'dot-go':m.att==='no'?'dot-no':m.att==='maybe'?'dot-maybe':'dot-none';
    return `<div class="mpill${isH?' mpill-host':isMe?' mpill-me':''}">
      <span>${u.avatar||'ğŸ‘¤'}</span>
      <div class="att-dot ${dot}"></div>
      <span>${u.name||'?'}${isMe?' (ë‚˜)':''}${isH?' ğŸ‘‘':''}</span>
      ${isMe ? `<button class="mpill-edit" onclick="openProfile()">âœï¸</button>` : ''}
    </div>`;
  }).join('');

  const hint = document.getElementById('member-empty-hint');
  if (hint) hint.innerHTML = cnt===0 ? '<div style="font-size:12px;color:var(--ink3);text-align:center;padding:10px 0">ì•„ë˜ ì´ˆëŒ€ ë²„íŠ¼ìœ¼ë¡œ ì¹œêµ¬ë¥¼ ë¶ˆëŸ¬ë³´ì„¸ìš” ğŸ‘‡</div>' : '';

  document.getElementById('invite-code').textContent = room.invite_code || 'â€”';

  // ì´ë¬´ ë°°ë„ˆ
  const banner = document.getElementById('host-info-banner');
  if (banner) {
    const hostMember = mbs.find(m => m.user_id === room.host_id);
    const hostName = hostMember?.users?.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
    banner.innerHTML = isHost()
      ? `<div class="host-banner host-banner-me">ğŸ‘‘ ë‚´ê°€ ì´ë¬´ì˜ˆìš” Â· <button class="btn-text-link" onclick="openHostPass()">ì´ë¬´ ë„˜ê¸°ê¸°</button></div>`
      : `<div class="host-banner">ğŸ‘‘ ì´ë¬´: <b>${hostName}</b></div>`;
  }

  renderMeetingsList();
}

async function onNameChange() {
  const name = document.getElementById('meeting-name').value;
  if (!rooms[activeRoomId]) return;
  rooms[activeRoomId].name = name;
  await db.from('rooms').update({ name }).eq('id', activeRoomId);
  renderMeetingsList();
}

// â”€â”€ MEETINGS LIST â”€â”€
function renderMeetingsList() {
  const wrap = document.getElementById('meetings-list');
  if (!wrap) return;
  wrap.innerHTML = myRoomIds.map(id => {
    const r = rooms[id] || {};
    const mbs = members[id] || [];
    const exps = expenses[id] || [];
    const dts = dates[id] || [];
    const isCur = id === activeRoomId;
    const isH = ME && r.host_id === ME.id;
    const total = exps.reduce((s,e) => s+e.amt, 0);
    const going = mbs.filter(m => m.att==='go').length;
    const meta = [mbs.length+'ëª…', dts.length?'ğŸ“…'+dts.length:'', going?'âœ…'+going:'', total?'â‚©'+total.toLocaleString():''].filter(Boolean).join(' Â· ');
    return `<div class="mt-card${isCur?' cur':''}" onclick="switchRoom('${id}')">
      <div class="mt-ico">${r.emoji||'ğŸ‰'}</div>
      <div class="mt-info">
        <div class="mt-name">${r.name||'ì´ë¦„ ì—†ëŠ” ëª¨ì„'}</div>
        <div class="mt-meta">${meta||'ì•„ì§ ë‚´ìš© ì—†ìŒ'}</div>
      </div>
      ${isCur?'<div class="mt-badge">í˜„ì¬</div>':''}
      ${isH?'<div class="mt-host-badge">ğŸ‘‘</div>':''}
      ${myRoomIds.length>1?`<button class="mt-del" onclick="leaveRoom('${id}',event)">ğŸšª</button>`:''}
    </div>`;
  }).join('');
}

async function switchRoom(id) {
  activeRoomId = id;
  localStorage.setItem('moyo-active-room', id);
  await loadRoomData(id);
  subscribeToRoom(id);
  renderAll();
  toast((rooms[id]?.name||'ëª¨ì„')+'ìœ¼ë¡œ ì „í™˜ëì–´ìš”');
}

async function leaveRoom(id, e) {
  e.stopPropagation();
  const r = rooms[id] || {};
  if (!confirm((r.name||'ëª¨ì„')+'ì—ì„œ ë‚˜ê°ˆê¹Œìš”?')) return;
  // ë‚´ ë©¤ë²„ì‹­ ì‚­ì œ
  await db.from('members').delete().eq('room_id', id).eq('user_id', ME.id);
  myRoomIds = myRoomIds.filter(x => x !== id);
  delete rooms[id];
  if (activeRoomId === id) {
    activeRoomId = myRoomIds[0] || null;
    localStorage.setItem('moyo-active-room', activeRoomId||'');
    if (activeRoomId) await loadRoomData(activeRoomId);
  }
  localStorage.setItem('moyo-my-rooms', JSON.stringify(myRoomIds));
  renderAll();
  toast('ë‚˜ì™”ì–´ìš”');
}

// â”€â”€ INVITE â”€â”€
function openInvite() { openSheet('invite'); }
function copyInviteLink() {
  const url = `${location.href.split('?')[0]}?join=${R().invite_code}`;
  copyText(url);
  toast('ì´ˆëŒ€ ë§í¬ ë³µì‚¬ëì–´ìš”! ì¹´í†¡ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš” ğŸ‰');
  closeSheet('invite');
}
function copyCode() { copyText(R().invite_code); toast('ì½”ë“œ ë³µì‚¬ëì–´ìš”!'); }

// â”€â”€ JOIN â”€â”€
async function joinMeeting() {
  const code = document.getElementById('join-code-inp').value.trim().toUpperCase();
  if (code.length!==6) { toast('6ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
  closeSheet('join');
  await handleInviteUrl(code);
  renderAll();
}

// â”€â”€ CREATE MEETING â”€â”€
function openCreateMeeting() {
  document.getElementById('emoji-picker').innerHTML = MT_EMOJIS.map((e,i) =>
    `<button onclick="selectEmoji(this,'${e}')" style="font-size:24px;background:${i===0?'var(--acc-l)':'var(--line2)'};border:1.5px solid ${i===0?'var(--acc-b)':'transparent'};border-radius:10px;width:42px;height:42px;cursor:pointer;transition:all .15s;" id="ep-${i}">${e}</button>`
  ).join('');
  selectedEmoji = MT_EMOJIS[0];
  openSheet('create');
}

function selectEmoji(el, em) {
  document.querySelectorAll('[id^="ep-"]').forEach(b => { b.style.background='var(--line2)'; b.style.borderColor='transparent'; });
  el.style.background='var(--acc-l)'; el.style.borderColor='var(--acc-b)';
  selectedEmoji = em;
}

async function createMeeting() {
  const name = document.getElementById('new-meeting-name').value.trim();
  if (!name) { toast('ëª¨ì„ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
  const roomId = genId();
  const room = { id: roomId, name, emoji: selectedEmoji, host_id: ME.id, invite_code: genCode() };
  await db.from('rooms').insert(room);
  await db.from('members').insert({ id: genId(), room_id: roomId, user_id: ME.id, att: 'none' });

  rooms[roomId] = room;
  members[roomId] = [{ id: genId(), room_id: roomId, user_id: ME.id, att: 'none', users: ME }];
  dates[roomId]=[]; places[roomId]=[]; expenses[roomId]=[]; memos[roomId]=[];

  myRoomIds.push(roomId);
  activeRoomId = roomId;
  localStorage.setItem('moyo-my-rooms', JSON.stringify(myRoomIds));
  localStorage.setItem('moyo-active-room', activeRoomId);
  subscribeToRoom(roomId);

  closeSheet('create');
  renderAll();
  toast('ğŸ‰ '+name+' ë§Œë“¤ì–´ì¡Œì–´ìš”!');
}

// â”€â”€ PROFILE â”€â”€
function openProfile() {
  if (!ME) return;
  profileAvatar = ME.avatar;
  const grid = document.getElementById('profile-av-grid');
  grid.innerHTML = AVATARS.slice(0,8).map(a =>
    `<button class="av-btn${a===ME.avatar?' on':''}" onclick="selectProfileAvatar(this,'${a}')">${a}</button>`
  ).join('');
  document.getElementById('profile-name-inp').value = ME.name;
  openSheet('profile');
}

function selectProfileAvatar(el, av) {
  document.querySelectorAll('#profile-av-grid .av-btn').forEach(b => b.classList.remove('on'));
  el.classList.add('on');
  profileAvatar = av;
}

async function saveProfile() {
  const newName = document.getElementById('profile-name-inp').value.trim();
  if (!newName) { toast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
  ME.name = newName;
  ME.avatar = profileAvatar || ME.avatar;
  localStorage.setItem('moyo-me', JSON.stringify(ME));
  await db.from('users').upsert({ id: ME.id, name: ME.name, avatar: ME.avatar });
  closeSheet('profile');
  renderHome();
  toast('í”„ë¡œí•„ì´ ë³€ê²½ëì–´ìš”! ğŸ‘¤');
}

// â”€â”€ HOST PASS â”€â”€
function openHostPass() {
  if (!isHost()) { toast('ì´ë¬´ë§Œ ë„˜ê¸¸ ìˆ˜ ìˆì–´ìš”'); return; }
  const others = getMembers().filter(m => m.user_id !== ME.id);
  if (!others.length) { toast('ë„˜ê¸¸ ë©¤ë²„ê°€ ì—†ì–´ìš”'); return; }
  document.getElementById('hostpass-list').innerHTML = others.map(m => {
    const u = m.users || {};
    return `<div class="row" style="cursor:pointer" onclick="passHost('${m.user_id}')">
      <span style="font-size:20px">${u.avatar||'ğŸ‘¤'}</span>
      <div style="flex:1;font-size:14px;font-weight:700">${u.name||'?'}</div>
      <button class="btn btn-acc btn-xs">ì´ë¬´ ë„˜ê¸°ê¸°</button>
    </div>`;
  }).join('');
  openSheet('hostpass');
}

async function passHost(uid) {
  const m = getMembers().find(x => x.user_id === uid);
  if (!m) return;
  const u = m.users || {};
  if (!confirm(`${u.name||'?'}ë‹˜ì—ê²Œ ì´ë¬´ë¥¼ ë„˜ê¸¸ê¹Œìš”?`)) return;
  await db.from('rooms').update({ host_id: uid }).eq('id', activeRoomId);
  rooms[activeRoomId].host_id = uid;
  closeSheet('hostpass');
  renderHome();
  toast(`ğŸ‘‘ ${u.name||'?'}ë‹˜ì´ ìƒˆ ì´ë¬´ê°€ ëì–´ìš”!`);
}

// â”€â”€ DATE â”€â”€
async function addDate() {
  const d = document.getElementById('date-inp').value;
  const t = document.getElementById('time-inp').value.trim();
  if (!d) { toast('ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”'); return; }
  const label = fmtDate(d)+(t?' '+t:'');
  if (getDates().find(x => x.label===label)) { toast('ì´ë¯¸ ìˆëŠ” ë‚ ì§œì˜ˆìš”'); return; }
  const row = { id: genId(), room_id: activeRoomId, label, voters: [], added_by: ME?.id };
  await db.from('dates').insert(row);
  dates[activeRoomId] = [...getDates(), row];
  renderDates();
  toast('ë‚ ì§œ ì¶”ê°€ëì–´ìš”!');
}

async function voteDate(id) {
  if (!ME) { toast('ë¨¼ì € í”„ë¡œí•„ì„ ì„¤ì •í•´ ì£¼ì„¸ìš”'); return; }
  const d = getDates().find(x => x.id===id);
  if (!d) return;
  const voters = d.voters || [];
  const idx = voters.indexOf(ME.id);
  const newVoters = idx>=0 ? voters.filter(v=>v!==ME.id) : [...voters, ME.id];
  await db.from('dates').update({ voters: newVoters }).eq('id', id);
  d.voters = newVoters;
  renderDates();
}

async function removeDate(id) {
  const d = getDates().find(x => x.id===id);
  if (!isHost() && !(ME && d?.added_by===ME.id)) { toast('ì´ë¬´ ë˜ëŠ” ë³¸ì¸ì´ ì¶”ê°€í•œ ë‚ ì§œë§Œ ì‚­ì œ ê°€ëŠ¥í•´ìš”'); return; }
  await db.from('dates').delete().eq('id', id);
  dates[activeRoomId] = getDates().filter(x => x.id!==id);
  renderDates();
}

function renderDates() {
  const dts = getDates();
  const wrap = document.getElementById('date-list');
  if (!dts.length) {
    wrap.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“…</div><div class="empty-text">ë‚ ì§œ í›„ë³´ë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”</div></div>';
  } else {
    const sorted = [...dts].sort((a,b) => (b.voters?.length||0)-(a.voters?.length||0));
    const maxV = Math.max(...sorted.map(d => d.voters?.length||0), 1);
    const topVotes = sorted[0].voters?.length||0;
    const topId = (sorted.length>1 && topVotes>0 && (sorted[1].voters?.length||0)<topVotes) ? sorted[0].id : null;
    wrap.innerHTML = sorted.map(d => {
      const vCount = d.voters?.length||0;
      const myVote = d.voters?.includes(ME?.id);
      return `<div class="row${d.id===topId?' date-best':''}">
        <div class="d-label">
          <div class="d-title">${d.label}</div>
          <div class="vote-bar"><div class="vote-fill" style="width:${vCount/maxV*100}%"></div></div>
          <div class="d-meta">${vCount}ëª… ê°€ëŠ¥${d.id===topId?' Â· ğŸ‘‘ ìµœë‹¤':''}</div>
        </div>
        <button class="vote-btn${myVote?' on':''}" onclick="voteDate('${d.id}')">${myVote?'âœ… ê°€ëŠ¥':'ğŸ™‹ ê°€ëŠ¥'}</button>
        ${(isHost()||(ME&&d.added_by===ME.id))?`<button class="del-btn" onclick="removeDate('${d.id}')">âœ•</button>`:''}
      </div>`;
    }).join('');
  }

  // ì°¸ì„ ì—¬ë¶€
  const mbs = getMembers();
  const sec = document.getElementById('att-section');
  if (!mbs.length) { sec.innerHTML=''; return; }
  const goC=mbs.filter(m=>m.att==='go').length;
  const noC=mbs.filter(m=>m.att==='no').length;
  const mayC=mbs.filter(m=>m.att==='maybe').length;
  const noneC=mbs.filter(m=>m.att==='none').length;
  sec.innerHTML = `
    <div class="sec">ì°¸ì„ ì—¬ë¶€</div>
    <div class="card">
      <div class="att-bar">
        ${goC?`<span class="att-chip att-chip-go">âœ… ì°¸ì„ ${goC}</span>`:''}
        ${noC?`<span class="att-chip att-chip-no">âŒ ë¶ˆì°¸ ${noC}</span>`:''}
        ${mayC?`<span class="att-chip att-chip-maybe">â“ ë¯¸ì • ${mayC}</span>`:''}
        ${noneC?`<span class="att-chip att-chip-none">â¬œ ë¯¸ì‘ë‹µ ${noneC}</span>`:''}
      </div>
      ${mbs.map(m => {
        const u = m.users||{};
        const isMe = ME && m.user_id===ME.id;
        return `<div class="row">
          <span style="font-size:18px">${u.avatar||'ğŸ‘¤'}</span>
          <div style="flex:1;font-size:14px;font-weight:700">${u.name||'?'}${isMe?' <span style="font-size:11px;color:var(--ink3)">(ë‚˜)</span>':''}</div>
          ${isMe?`<div class="att-btns">
            <button class="att-btn${m.att==='go'?' go':''}" onclick="setAtt('${m.id}','go')">ì°¸ì„</button>
            <button class="att-btn${m.att==='no'?' no':''}" onclick="setAtt('${m.id}','no')">ë¶ˆì°¸</button>
            <button class="att-btn${m.att==='maybe'?' maybe':''}" onclick="setAtt('${m.id}','maybe')">ë¯¸ì •</button>
          </div>`:`<span class="badge ${m.att==='go'?'badge-green':m.att==='no'?'badge-red':m.att==='maybe'?'badge-amber':'badge-gray'}">${m.att==='go'?'âœ… ì°¸ì„':m.att==='no'?'âŒ ë¶ˆì°¸':m.att==='maybe'?'â“ ë¯¸ì •':'â¬œ ë¯¸ì‘ë‹µ'}</span>`}
        </div>`;
      }).join('')}
    </div>`;
}

async function setAtt(memberId, status) {
  const m = getMembers().find(x => x.id===memberId);
  if (!m) return;
  const newAtt = m.att===status ? 'none' : status;
  await db.from('members').update({ att: newAtt }).eq('id', memberId);
  m.att = newAtt;
  renderDates(); renderHome();
}

function fmtDate(s) {
  const d = new Date(s+'T00:00:00');
  return d.toLocaleDateString('ko-KR',{month:'long',day:'numeric',weekday:'short'});
}

// â”€â”€ PLACE â”€â”€
async function addPlace() {
  const name = document.getElementById('place-name').value.trim();
  const cat = document.getElementById('place-cat').value.trim();
  const price = document.getElementById('place-price').value.trim();
  if (!name) { toast('ì¥ì†Œ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
  const row = { id: genId(), room_id: activeRoomId, name, cat: cat||'ê¸°íƒ€', price, liked_by: [], added_by: ME?.id };
  await db.from('places').insert(row);
  places[activeRoomId] = [...getPlaces(), row];
  renderPlaces();
  ['place-name','place-cat','place-price'].forEach(id => document.getElementById(id).value='');
  toast(name+' ì¶”ê°€ëì–´ìš”!');
}

async function likePlace(id) {
  if (!ME) { toast('ë¨¼ì € í”„ë¡œí•„ì„ ì„¤ì •í•´ ì£¼ì„¸ìš”'); return; }
  const p = getPlaces().find(x => x.id===id);
  if (!p) return;
  const liked = p.liked_by||[];
  const idx = liked.indexOf(ME.id);
  const newLiked = idx>=0 ? liked.filter(v=>v!==ME.id) : [...liked, ME.id];
  await db.from('places').update({ liked_by: newLiked }).eq('id', id);
  p.liked_by = newLiked;
  renderPlaces();
}

async function removePlace(id) {
  const p = getPlaces().find(x => x.id===id);
  if (!isHost() && !(ME && p?.added_by===ME.id)) { toast('ì´ë¬´ ë˜ëŠ” ë³¸ì¸ì´ ì¶”ê°€í•œ ì¥ì†Œë§Œ ì‚­ì œ ê°€ëŠ¥í•´ìš”'); return; }
  await db.from('places').delete().eq('id', id);
  places[activeRoomId] = getPlaces().filter(x => x.id!==id);
  renderPlaces();
}

function renderPlaces() {
  const wrap = document.getElementById('place-list');
  const pls = getPlaces();
  if (!pls.length) { wrap.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“</div><div class="empty-text">ì¥ì†Œ í›„ë³´ë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”</div></div>'; return; }
  const sorted = [...pls].sort((a,b) => (b.liked_by?.length||0)-(a.liked_by?.length||0));
  wrap.innerHTML = sorted.map((p,i) => {
    const liked = p.liked_by?.includes(ME?.id);
    const canDel = isHost()||(ME&&p.added_by===ME.id);
    return `<div class="row">
      <div class="rank${i===0&&(p.liked_by?.length||0)>0?' top':''}">${i+1}</div>
      <div class="pl-info"><div class="pl-name">${p.name}</div><div class="pl-meta">${p.cat}${p.price?' Â· '+p.price:''}</div></div>
      <button class="like-btn${liked?' on':''}" onclick="likePlace('${p.id}')">${liked?'â¤ï¸':'ğŸ¤'} ${p.liked_by?.length||0}</button>
      ${canDel?`<button class="del-btn" onclick="removePlace('${p.id}')">âœ•</button>`:''}
    </div>`;
  }).join('');
}

function suggestPlaces(cat) {
  const list = SUGGEST_DATA[cat]||[];
  document.getElementById('sug-wrap').innerHTML = `<div style="border-top:1px solid var(--line2);margin-top:10px;padding-top:10px">
    ${list.map(p=>`<div class="sug-row">
      <div class="sug-info"><div class="sug-name">${p.name}</div><div class="sug-meta">${p.cat} Â· ${p.price}</div></div>
      <button class="btn btn-line btn-xs" onclick="quickPlace('${p.name}','${p.cat}','${p.price}')">ì¶”ê°€</button>
    </div>`).join('')}
  </div>`;
}

async function quickPlace(name,cat,price) {
  if(getPlaces().find(p=>p.name===name)){toast('ì´ë¯¸ ìˆì–´ìš”');return;}
  const row={id:genId(),room_id:activeRoomId,name,cat,price,liked_by:[],added_by:ME?.id};
  await db.from('places').insert(row);
  places[activeRoomId]=[...getPlaces(),row];
  renderPlaces();toast(name+' ì¶”ê°€ëì–´ìš”!');
}

// â”€â”€ DUTCH â”€â”€
function renderDutch() {
  const mbs = getMembers();
  const exps = getExpenses();
  const count = mbs.length||1;
  const total = exps.reduce((s,e)=>s+e.amt,0);
  const per = Math.ceil(total/count);
  document.getElementById('d-total').textContent='â‚©'+total.toLocaleString();
  document.getElementById('d-per').textContent='â‚©'+per.toLocaleString();
  document.getElementById('d-count').textContent=count+'ëª… ê¸°ì¤€';

  const addArea = document.getElementById('dutch-add-area');
  if (isHost()) {
    addArea.innerHTML = `<div class="card card-p" style="margin-bottom:12px">
      <div style="font-size:11px;font-weight:700;color:var(--ink3);letter-spacing:.5px;margin-bottom:10px">ì§€ì¶œ ì¶”ê°€ <span class="badge badge-gold">ğŸ‘‘ ì´ë¬´</span></div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="inp-row">
          <input class="inp" id="exp-name" placeholder="í•­ëª© (ì˜ˆ: ì‚¼ê²¹ì‚´)">
          <input class="inp" type="number" id="exp-amt" placeholder="ê¸ˆì•¡" style="max-width:110px">
        </div>
        <div class="inp-row">
          <input class="inp" id="exp-payer" placeholder="ë‚¸ ì‚¬ëŒ">
          <button class="btn btn-acc btn-sm" onclick="addExpense()" style="flex-shrink:0">ì¶”ê°€</button>
        </div>
      </div>
    </div>`;
  } else {
    addArea.innerHTML = `<div class="lock-hint">ğŸ”’ ì´ë¬´ë§Œ ì§€ì¶œì„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”</div>`;
  }

  const expW = document.getElementById('exp-list');
  expW.innerHTML = exps.length
    ? exps.map(e=>`<div class="row">
        <div style="flex:1"><div style="font-size:14px;font-weight:700">${e.name}</div><div style="font-size:11px;color:var(--ink3);margin-top:2px">${e.payer} ê²°ì œ</div></div>
        <div style="font-size:15px;font-weight:800">â‚©${e.amt.toLocaleString()}</div>
        ${isHost()?`<button class="del-btn" onclick="removeExpense('${e.id}')">âœ•</button>`:''}
      </div>`).join('')
    : '<div class="empty"><div class="empty-icon">ğŸ’¸</div><div class="empty-text">ì§€ì¶œ ë‚´ì—­ì´ ì—†ì–´ìš”</div></div>';

  const settW = document.getElementById('settle-result');
  if (!exps.length||mbs.length<2) {
    settW.innerHTML=`<div class="card card-p" style="text-align:center;color:var(--ink3);font-size:13px">ë©¤ë²„ 2ëª… ì´ìƒ + ì§€ì¶œ ì¶”ê°€ í›„ ê²°ê³¼ê°€ ë‚˜ì™€ìš”</div>`;
    return;
  }
  const memberNames = mbs.map(m => m.users?.name||'?');
  const paid={};memberNames.forEach(n=>{paid[n]=0;});
  exps.forEach(e=>{if(paid.hasOwnProperty(e.payer))paid[e.payer]+=e.amt;});
  const bal={};memberNames.forEach(n=>{bal[n]=(paid[n]||0)-per;});
  const cred=Object.entries(bal).filter(([,v])=>v>0).map(([n,v])=>({n,v}));
  const debt=Object.entries(bal).filter(([,v])=>v<0).map(([n,v])=>({n,v:Math.abs(v)}));
  const lines=[];let ci=0,di=0;
  while(ci<cred.length&&di<debt.length){
    const pay=Math.min(cred[ci].v,debt[di].v);
    if(pay>100)lines.push({from:debt[di].n,to:cred[ci].n,amt:Math.round(pay)});
    cred[ci].v-=pay;debt[di].v-=pay;
    if(cred[ci].v<100)ci++;if(debt[di].v<100)di++;
  }
  settW.innerHTML=lines.length
    ?lines.map(s=>`<div class="settle-card"><span class="sf">${s.from}</span><span style="color:var(--ink3);font-size:11px">â†’</span><span class="st">${s.to}</span><span class="sa">â‚©${s.amt.toLocaleString()}</span></div>`).join('')
    :`<div class="settle-card" style="justify-content:center;color:var(--green);font-weight:700">âœ… 1ì¸ë‹¹ â‚©${per.toLocaleString()} ê· ë“± ì •ì‚°!</div>`;
}

async function addExpense() {
  const name=document.getElementById('exp-name').value.trim();
  const amt=parseInt(document.getElementById('exp-amt').value)||0;
  const payer=document.getElementById('exp-payer').value.trim();
  if(!name||!amt){toast('í•­ëª©ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”');return;}
  const row={id:genId(),room_id:activeRoomId,name,amt,payer:payer||'ë¯¸ì§€ì •',added_by:ME?.id};
  await db.from('expenses').insert(row);
  expenses[activeRoomId]=[...getExpenses(),row];
  renderDutch();
  ['exp-name','exp-amt','exp-payer'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  toast('ì§€ì¶œ ì¶”ê°€ëì–´ìš”!');
}

async function removeExpense(id) {
  await db.from('expenses').delete().eq('id',id);
  expenses[activeRoomId]=getExpenses().filter(e=>e.id!==id);
  renderDutch();
}

// â”€â”€ MEMO â”€â”€
function setMemoType(type) {
  memoType=type;
  document.getElementById('tb-notice').classList.toggle('on',type==='notice');
  document.getElementById('tb-memo').classList.toggle('on',type==='memo');
}

async function addMemo() {
  const text=document.getElementById('memo-inp').value.trim();
  if(!text){toast('ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”');return;}
  const row={id:genId(),room_id:activeRoomId,type:memoType,text,author_id:ME?.id,author_name:ME?.name||'ìµëª…'};
  await db.from('memos').insert(row);
  memos[activeRoomId]=[row,...getMemos()];
  renderMemos();
  document.getElementById('memo-inp').value='';
  toast(memoType==='notice'?'ğŸ“¢ ê³µì§€ ë“±ë¡ëì–´ìš”!':'ğŸ“ ë©”ëª¨ ë“±ë¡ëì–´ìš”!');
}

async function removeMemo(id) {
  const m=getMemos().find(x=>x.id===id);
  if(!isHost()&&!(ME&&m?.author_id===ME.id)){toast('ì´ë¬´ ë˜ëŠ” ì‘ì„±ìë§Œ ì‚­ì œ ê°€ëŠ¥í•´ìš”');return;}
  await db.from('memos').delete().eq('id',id);
  memos[activeRoomId]=getMemos().filter(x=>x.id!==id);
  renderMemos();
}

function renderMemos() {
  const wrap=document.getElementById('memo-list');
  const mos=getMemos();
  wrap.innerHTML=mos.length
    ?mos.map(m=>`<div class="memo-item">
        <div class="memo-top">
          <span class="badge ${m.type==='notice'?'badge-acc':'badge-gray'}">${m.type==='notice'?'ğŸ“¢ ê³µì§€':'ğŸ“ ë©”ëª¨'}</span>
          <div class="memo-body">${m.text.replace(/\n/g,'<br>')}</div>
          ${(isHost()||(ME&&m.author_id===ME.id))?`<button class="del-btn" onclick="removeMemo('${m.id}')">âœ•</button>`:''}
        </div>
        <div class="memo-time">${m.author_name} Â· ${new Date(m.created_at).toLocaleString('ko-KR',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
      </div>`).join('')
    :'<div class="empty"><div class="empty-icon">ğŸ“</div><div class="empty-text">ê³µì§€ë‚˜ ë©”ëª¨ë¥¼ ì‘ì„±í•´ ë³´ì„¸ìš”</div></div>';
}

// â”€â”€ SHARE â”€â”€
function openShare() {
  const room=R(); const mbs=getMembers(); const exps=getExpenses();
  const total=exps.reduce((s,e)=>s+e.amt,0);
  const count=mbs.length||1; const per=Math.ceil(total/count);
  const best=[...getDates()].sort((a,b)=>(b.voters?.length||0)-(a.voters?.length||0))[0];
  const topPl=[...getPlaces()].sort((a,b)=>(b.liked_by?.length||0)-(a.liked_by?.length||0))[0];
  const going=mbs.filter(m=>m.att==='go');
  const notices=getMemos().filter(m=>m.type==='notice');
  let t=`ğŸ‰ ${room.name||'ìš°ë¦¬ ëª¨ì„'} ì •ì‚° ìš”ì•½\n${'â”€'.repeat(22)}\n`;
  if(best?.voters?.length>0)t+=`ğŸ“… ë‚ ì§œ: ${best.label} (${best.voters.length}ëª… ê°€ëŠ¥)\n`;
  if(topPl)t+=`ğŸ“ ì¥ì†Œ: ${topPl.name}${topPl.price?' ('+topPl.price+')':''}\n`;
  if(going.length)t+=`âœ… ì°¸ì„: ${going.map(m=>m.users?.name||'?').join(', ')}\n`;
  t+=`\nğŸ’° ì§€ì¶œ ë‚´ì—­\n`;
  exps.forEach(e=>{t+=`â€¢ ${e.name}: â‚©${e.amt.toLocaleString()} (${e.payer})\n`;});
  t+=`\nì´ì•¡: â‚©${total.toLocaleString()}\n1ì¸ë‹¹: â‚©${per.toLocaleString()} (${count}ëª…)\n`;
  if(notices.length){t+=`\nğŸ“¢ ê³µì§€\n`;notices.forEach(n=>{t+=`â€¢ ${n.text}\n`;});}
  t+=`\nëª¨ì—¬ ì•±ìœ¼ë¡œ ë§Œë“¤ì—ˆì–´ìš” ğŸ‰`;
  document.getElementById('share-text').textContent=t;
  openSheet('share');
}

function copyShare(){copyText(document.getElementById('share-text').textContent);toast('ë³µì‚¬ëì–´ìš”! ì¹´í†¡ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš” ğŸ’¬');closeSheet('share');}

// â”€â”€ SHEET UTILS â”€â”€
function openSheet(id){document.getElementById('ov-'+id).classList.add('on');}
function closeSheet(id){document.getElementById('ov-'+id).classList.remove('on');}
function closeOv(id,e){if(e.target.id==='ov-'+id)closeSheet(id);}

// â”€â”€ COPY â”€â”€
function copyText(t){
  if(navigator.clipboard)navigator.clipboard.writeText(t);
  else{const ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);}
}

// â”€â”€ TOAST â”€â”€
let _tt;
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('on');
  clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('on'),2400);
}

// â”€â”€ WINDOW EXPOSE â”€â”€
Object.assign(window,{
  goTab, completeOnboarding, selectAvatar,
  openInvite, copyInviteLink, copyCode,
  joinMeeting, openCreateMeeting, selectEmoji, createMeeting,
  switchRoom, leaveRoom,
  openProfile, selectProfileAvatar, saveProfile,
  openHostPass, passHost,
  addDate, voteDate, removeDate, setAtt,
  addPlace, likePlace, removePlace, suggestPlaces, quickPlace,
  addExpense, removeExpense,
  setMemoType, addMemo, removeMemo,
  openShare, copyShare,
  openSheet, closeSheet, closeOv,
  onNameChange, toast,
});

// â”€â”€ START â”€â”€
init();
</script>
</body>
</html>
